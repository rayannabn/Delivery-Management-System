{% extends "base.html" %}

{% block title %}Dashboard - Delivery Management System{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä Daily Summary</h2>
    <div id="summary-content">
        <div class="loading">Loading summary...</div>
    </div>
    <div class="actions">
        <button class="btn" onclick="loadSummary()">Refresh</button>
        <button class="btn btn-success" onclick="runAllocation()">Run Allocation</button>
        <button class="btn btn-warning" onclick="generateSeedData()">Generate Test Data</button>
    </div>
</div>

<div class="stats-grid" id="stats-grid">
    <!-- Stats will be loaded here -->
</div>

<div class="card">
    <h2>üìã Recent Assignments</h2>
    <div id="assignments-content">
        <div class="loading">Loading assignments...</div>
    </div>
</div>

<div class="card">
    <h2>üè¢ System Status</h2>
    <div id="system-status">
        <div class="loading">Loading system status...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let today = new Date().toISOString().split('T')[0];

function loadSummary() {
    const summaryContent = document.getElementById('summary-content');
    showLoading(summaryContent);
    
    fetch(`/api/summary/${today}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            summaryContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.total_agents || 0}</div>
                        <div class="stat-label">Agents Working</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.total_orders || 0}</div>
                        <div class="stat-label">Orders Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.total_distance || 0} km</div>
                        <div class="stat-label">Total Distance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${formatCurrency(data.total_cost || 0)}</div>
                        <div class="stat-label">Total Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.avg_orders_per_agent || 0}</div>
                        <div class="stat-label">Avg Orders/Agent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.deferred_orders || 0}</div>
                        <div class="stat-label">Deferred Orders</div>
                    </div>
                </div>
            `;
            
            updateStatsGrid(data);
        })
        .catch(error => {
            showError('Failed to load summary: ' + error.message);
        });
}

function updateStatsGrid(data) {
    const statsGrid = document.getElementById('stats-grid');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${data.total_orders || 0}</div>
            <div class="stat-label">üì¶ Total Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${data.total_agents || 0}</div>
            <div class="stat-label">üë∑ Active Agents</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${(data.total_distance || 0).toFixed(1)} km</div>
            <div class="stat-label">üöó Distance Covered</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${formatCurrency(data.total_cost || 0)}</div>
            <div class="stat-label">üí∞ Total Cost</div>
        </div>
    `;
}

function loadAssignments() {
    const assignmentsContent = document.getElementById('assignments-content');
    showLoading(assignmentsContent);
    
    fetch(`/api/assignments/${today}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            if (!data.assignments || data.assignments.length === 0) {
                assignmentsContent.innerHTML = '<p>No assignments found for today.</p>';
                return;
            }
            
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Orders</th>
                            <th>Distance</th>
                            <th>Time</th>
                            <th>Earnings</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.assignments.slice(0, 10).forEach(assignment => {
                html += `
                    <tr>
                        <td>${assignment.agent_name || 'Unknown'}</td>
                        <td>${assignment.order_ids.length}</td>
                        <td>${assignment.total_distance.toFixed(1)} km</td>
                        <td>${assignment.total_time.toFixed(1)} hrs</td>
                        <td>${formatCurrency(assignment.total_earning)}</td>
                        <td>${formatCurrency(assignment.earning_per_order)}/order</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            if (data.assignments.length > 10) {
                html += `<p style="margin-top: 10px; color: #666;">Showing 10 of ${data.assignments.length} assignments</p>`;
            }
            
            assignmentsContent.innerHTML = html;
        })
        .catch(error => {
            showError('Failed to load assignments: ' + error.message);
        });
}

function loadSystemStatus() {
    const statusContent = document.getElementById('system-status');
    
    fetch('/api/health')
        .then(response => response.json())
        .then(data => {
            statusContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.status === 'healthy' ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">System Health</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.scheduler_running ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">Scheduler Running</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${formatDate(data.timestamp)}</div>
                        <div class="stat-label">Last Update</div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            statusContent.innerHTML = '<div class="error">Failed to load system status</div>';
        });
}

function runAllocation() {
    if (!confirm('Are you sure you want to run the allocation process?')) {
        return;
    }
    
    fetch('/run-allocation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(`Allocation completed! ${data.total_assigned} orders assigned, ${data.total_deferred} deferred.`);
            loadSummary();
            loadAssignments();
        } else {
            showError('Allocation failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        showError('Failed to run allocation: ' + error.message);
    });
}

function generateSeedData() {
    if (!confirm('This will clear all existing data and generate new test data. Continue?')) {
        return;
    }
    
    fetch('/seed-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
            return;
        }
        
        showSuccess(`Test data generated successfully! ${data.summary.warehouses} warehouses, ${data.summary.agents} agents, ${data.summary.orders} orders.`);
        loadSummary();
        loadAssignments();
    })
    .catch(error => {
        showError('Failed to generate seed data: ' + error.message);
    });
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSummary();
    loadAssignments();
    loadSystemStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        loadSummary();
        loadSystemStatus();
    }, 30000);
});
</script>
{% endblock %}
